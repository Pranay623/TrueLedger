generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}
enum Role {
  INSTITUTION
  STUDENT
}

model User {
  id                  String         @id @default(uuid())
  email               String         @unique
  username            String         @unique
  password            String
  fullName            String?
  securityId          String         @unique
  admin               Boolean        @default(false)
  avatar              String?
  usertype            Role           @default(STUDENT)
  institutionname     String?
  refreshToken        String?
  failedLoginAttempts Int            @default(0)
  accountLocked       Boolean        @default(false)
  lockExpiresAt       DateTime?
  lastLogin           DateTime       @default(now())
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  certificates        Certificate[]
  performedLogs       CertificateLog[] @relation("UserToCertificateLog")

  @@map("users")
}

model Certificate {
  id             String   @id @default(uuid())
  title          String?
  description    String?
  fileUrl        String
  fileType       String
  s3Key          String

  status         CertificateStatus @default(PENDING)
  verificationHash String?

  ownerId        String
  owner          User @relation(fields: [ownerId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  logs           CertificateLog[]  @relation("CertificateToCertificateLog")
}

enum CertificateStatus {
  PENDING
  VERIFIED
  APPROVED
  REJECTED
}

model CertificateLog {
  id            String   @id @default(uuid())

  certificateId String
  action        String
  performedById String
  metadata      Json?

  createdAt     DateTime @default(now())

  certificate   Certificate @relation("CertificateToCertificateLog", fields: [certificateId], references: [id])
  performedBy   User        @relation("UserToCertificateLog", fields: [performedById], references: [id])

  @@index([certificateId])
  @@index([performedById])
}
